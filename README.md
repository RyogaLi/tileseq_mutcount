## TileSeq mutation count package

This package is made to parse input sequecning files (fastq) with user provided parameter.csv file.
Output of this pipeline is mutation counts for each pair of fastq files. 

## Dependencies

`python 3.6+`

`R` (version?)

`Bowtie2`

### Execution
---
**Before you run this pipeline, please goto `settings.py` to set the path to `BOWTIE2`**

To run this pipeline on DC (default)

`python main.py -p param_csv -o output_folder -f fastq_file_folder`

```
Example (DC): 

python main.py -p $HOME/dev/tilseq_mutcount/190506_param_MTHFR.json -o $HOME/dev/tilseq_mutcount/output/ -f $HOME/tileseq_data/WT/

Required parameters: #required from users

-p PARAM, parameter csv file (please see details in the input files section) 
-o OUTPUT, Output directory
-f FASTQ, Path to fastq files you want to analyze

Optional parameters:
-h, --help Show help message

-env ENVIRONMENT, Name of cluster you want to run this script (default = DC), you can pick from DC, BC2 or GURU.
-log LOG_LEVEL, Log level of the logging object: debug, info, warning, error, critical (default = info)
-qual QUALITY, posterior probability cutoff (default = 0.99)
-

--skip_alignment, Skip alignment for this run. Alignment output already exist and the output path should be the output generated by a previous run

Example of skipping alignment: 

python main.py -p $HOME/dev/tilseq_mutcount/190506_param_MTHFR.json -o /home/rothlab1/rli/dev/tilseq_mutcount/output/190506_MTHFR_WT_2020-01-29-17-07-04/ -f $HOME/tileseq_data/WT/ --skip_alignment
```


### Input files
---

`/path/to/fastq/` - Full path to input fastq files 

`param.csv` - CSV file contains information for this run (please see example
[here](https://docs.google.com/spreadsheets/d/1tIblmIFgOApPNzWN2KUwj8BKzBiJ1pOL7R4AOUGrqvE/edit?usp=sharing)
).
This file is required to be comma-seperated and saved in csv format. 


### Output files
---

One ouptut folder is created for each run. The output folder are named with `project-name_time-stamp`

Within each output folder, the following files and folders will be generated:

`./main.log` - main logging file

`./param.log` - parameters for this run (and all the other runs that using the same output folder)

`./ref/` - Reference fasta file and bowtie2 index

`./env_aln_sh/` - Bash scripts for submitting the alignment jobs

`./sam_files/` - Alignemnt output and log files for the raw fastq files

`./time-stamp_mut_count/` - Mutation counts in each sample are saved in csv files 
    - `./time-stamp_mut_count/info.csv` - Meta information for each sample: sequencing depth, tile starts/ends and # of reads mapped outside of the targeted tile
    - `./time-stamp_mut_count/count_sample**.csv` - Raw mutation counts for each sample. With meta data in header. Variants are represented in hgvs format
    - `./time-stamp_mut_count/env_mut_sh/` - Bash scripts for summitting the mutation count jobs
    - `./time-stamp_mut_count/mut_log/` - Log file for each sample

The count_sample\*\*.csv is passed to tileseqMave for further analysis

### Alignment
---

The pipeline takes the sequence in the parameter file as reference and align the fastq files
to the whole reference sequence. This is the sequence specified by user in the parameter file.

For each pair of fastq files (R1 and R2), the pipeline submits one alignment job to the cluster. In the folder `env_sh` you can find all the scripts that were submitted to the cluster when you run `main.py`. 

Alignments were done using `Bowtie2` with following parameters:

```
~/bowtie2 --no-head --norc --no-sq --local -x {ref} -U {r1} -S {r1_sam_file}
~/bowtie2 --no-head --nofw --no-sq --local -x {ref} -U {r1} -S {r1_sam_file}
```

### Mutation Calls
---
